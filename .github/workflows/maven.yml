name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: Execute Remote Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.host }}
        username: ${{ secrets.username }}
        password: ${{ secrets.key }}
        timeout: 30m
        command_timeout: 30m
        script: |
          # 1. Force kill anything running on Port 80
          fuser -k 80/tcp || echo "Port 80 was already free."
          
          # 2. Go to project folder
          cd /var/www/html/NewsHub
          
          # 3. Force Sync Code
          git fetch --all
          git reset --hard origin/main
          
          # 4. COMPILE ON VPS
          # Ensure the FULL JDK 21 is installed (Compiler was missing/old)
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -y
          sudo apt-get install -y openjdk-21-jdk-headless
          
          # Set JAVA_HOME
          export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          
          echo "Java Version:"
          java -version
          echo "Compiler Version:"
          javac -version
          
          # Ensure Maven Wrapper exists
          mvn wrapper:wrapper
          chmod +x mvnw
          
          # Build using the wrapper AND force the correct compiler executable
          ./mvnw clean package -DskipTests -Dmaven.compiler.fork=true -Dmaven.compiler.executable=$JAVA_HOME/bin/javac
          
          # 5. Start App
          # Rename to generic app.jar
          rm -f app.jar
          mv target/*.jar app.jar
          
          # Manually source bashrc to get the key, then run with sudo -E (Preserve Env)
          export GEMINI_API_KEY=$(grep GEMINI_API_KEY ~/.bashrc | cut -d '"' -f 2)
          
          # Fallback if grep failed (user can also add secret to github actions if this fails)
          if [ -z "$GEMINI_API_KEY" ]; then
             echo "WARNING: Could not find GEMINI_API_KEY in .bashrc"
          else
             echo "Found API Key length: ${#GEMINI_API_KEY}"
          fi

          sudo -E setsid java -jar app.jar > log.txt 2>&1 < /dev/null &
          
          # 6. Verify
          sleep 10
          echo "====== SERVER LOGS (Last 100 lines) ======"
          tail -n 100 log.txt
          echo "========================================="
          echo "Deployment script finished."
          exit 0