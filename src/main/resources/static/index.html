<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --nh-black: #0a0a0a;
            --nh-dark-gray: #161616;
            --nh-card-bg: #1e1e1e;
            --nh-orange: #ff9900;
            --nh-orange-hover: #e68a00;
            --nh-text-main: #ffffff;
            --nh-text-muted: #a0a0a0;
            --nh-border: #333333;
        }

        body { 
            background-color: var(--nh-black); 
            color: var(--nh-text-main); 
            font-family: 'Inter', sans-serif; 
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Navbar */
        .navbar { 
            background-color: rgba(22, 22, 22, 0.95) !important; 
            border-bottom: 1px solid #333;
            backdrop-filter: blur(10px);
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .navbar-brand { 
            font-weight: 800; 
            font-size: 1.5rem;
            letter-spacing: -0.5px; 
        }
        .brand-news { color: #fff; }
        .brand-hub { color: var(--nh-orange); }
        
        /* Controls & Inputs */
        .form-select, .form-control {
            background-color: #111;
            border-color: #333;
            color: #fff;
            font-size: 0.9rem;
        }
        .form-select:focus, .form-control:focus {
            background-color: #111;
            border-color: var(--nh-orange);
            color: #fff;
            box-shadow: 0 0 0 0.25rem rgba(255, 153, 0, 0.25);
        }

        /* Tabs */
        .nav-tabs { border-bottom: 1px solid #333; margin-bottom: 2rem; gap: 0.5rem; }
        .nav-tabs .nav-link { 
            color: var(--nh-text-muted); 
            border: none; 
            background: transparent;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .nav-tabs .nav-link:hover { color: #fff; background-color: rgba(255,255,255,0.05); }
        .nav-tabs .nav-link.active { 
            background-color: var(--nh-orange); 
            color: #000; 
        }

        /* Cards */
        .news-card {    
            background-color: var(--nh-card-bg); 
            border: 1px solid var(--nh-border); 
            color: var(--nh-text-main);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; 
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .news-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); 
            border-color: var(--nh-orange);
        }
        .card-img-top {
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid var(--nh-border);
            background-color: #000;
        }
        .card-body { padding: 1.5rem; display: flex; flex-direction: column; height: 100%; }
        .card-title { 
            font-weight: 700; 
            color: #fff; 
            font-size: 1.15rem; 
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        .card-subtitle { 
            color: var(--nh-text-muted) !important; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            margin-bottom: 1rem; 
        }
        .card-text { 
            color: #ccc; 
            font-size: 0.95rem; 
            line-height: 1.6; 
            flex-grow: 1;
        }
        
        /* AI Placeholder/Analysis Area */
        .ai-placeholder {
            background: rgba(255, 153, 0, 0.03);
            border: 1px dashed #444;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #999;
        }
        
        /* Buttons */
        .btn-primary, .btn-warning { 
            background-color: var(--nh-orange); 
            border: none; 
            color: #000; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .btn-primary:hover, .btn-warning:hover { 
            background-color: var(--nh-orange-hover); 
            color: #000;
            transform: translateY(-1px);
        }
        .btn-outline-secondary {
            border-color: #444;
            color: #aaa;
            font-weight: 600;
        }
        .btn-outline-secondary:hover {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        .btn-outline-light { border-color: #444; color: #ccc; }
        .btn-outline-light:hover { background-color: #333; color: #fff; border-color: #666; }

        /* Modal */
        .modal-content { 
            background-color: #1a1a1a; 
            color: #fff; 
            border: 1px solid #444; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 12px;
        }
        .modal-header { border-bottom: 1px solid #333; padding: 1.5rem; }
        .modal-footer { border-top: 1px solid #333; padding: 1.5rem; }
        .modal-body { padding: 2rem; }
        .btn-close { filter: invert(1); opacity: 0.7; }
        .btn-close:hover { opacity: 1; }

        /* Analysis Details */
        .impact-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 700;
            letter-spacing: 1px;
            display: inline-block;
            text-transform: uppercase;
        }
        .score-box {
            border: 3px solid var(--nh-orange);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--nh-orange);
            background: rgba(255, 153, 0, 0.05);
        }
        .section-title {
            color: var(--nh-orange);
            border-bottom: 1px solid #333;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 1.5px;
        }
        .section-title:first-of-type { margin-top: 0; }
        
        .article-reader {
            max-height: 65vh;
            overflow-y: auto;
            background: #111;
            padding: 2rem;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            line-height: 1.8;
            font-size: 1.05rem;
            color: #e0e0e0;
            white-space: pre-wrap;
            border: 1px solid #222;
        }

        /* Status Bar */
        .ai-status-bar {
            background: #1e1e1e;
            border: 1px solid #333;
            border-left: 4px solid var(--nh-orange);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 2rem;
            color: #ccc;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .pulsating-dot {
            width: 8px;
            height: 8px;
            background-color: var(--nh-orange);
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(255, 153, 0, 0.7);
            animation: pulse-orange 2s infinite;
        }
        @keyframes pulse-orange {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 153, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(255, 153, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 153, 0, 0); }
        }

        /* Loading */
        .loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner-grow { width: 3rem; height: 3rem; color: var(--nh-orange) !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        /* Utilities */
        .link-list a { 
            color: var(--nh-orange);
            text-decoration: none;
            display: block;
            margin-bottom: 4px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .link-list a:hover { opacity: 1; text-decoration: underline; }
        .text-justify { text-align: justify; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <span class="brand-news">News</span><span class="brand-hub">Hub</span>
            </a>
            
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="ms-auto d-flex align-items-center gap-3 flex-wrap my-2 my-lg-0">
                    <div class="input-group input-group-sm" style="width: auto;">
                        <span class="input-group-text bg-dark border-secondary text-secondary">Model</span>
                        <select id="model-select" class="form-select bg-dark text-light border-secondary">
                            <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        </select>
                        <span class="input-group-text bg-dark border-secondary text-secondary" data-bs-toggle="tooltip" title="Auto-Fallback Active">‚ÑπÔ∏è</span>
                    </div>

                    <select id="lang-select" class="form-select form-select-sm bg-dark text-light border-secondary" style="width: auto;">
                        <option value="English">English</option>
                        <option value="Chinese">‰∏≠Êñá (Chinese)</option>
                    </select>

                    <button id="refresh-button" class="btn btn-outline-light btn-sm px-3">Refresh</button>
                    <button class="btn btn-outline-warning btn-sm px-3" data-bs-toggle="modal" data-bs-target="#importModal">Import</button>
                    <a href="database-view.html" class="btn btn-outline-secondary btn-sm px-3">DB View</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manual Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">Paste BBC article URLs (one per line) to analyze and add them to the list.</p>
                    <textarea id="import-urls" class="form-control bg-dark text-light border-secondary" rows="8" placeholder="https://www.bbc.com/news/article..."></textarea>
                    <div id="import-status" class="mt-3 small"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="runImport()">Process Import</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <ul class="nav nav-tabs" id="newsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="bbc-new-tab" data-bs-toggle="tab" data-bs-target="#bbc-new-pane" type="button" role="tab" aria-selected="true" onclick="switchTab('bbc-new')">BBC AI Analyzed</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bbc-summarized-tab" data-bs-toggle="tab" data-bs-target="#bbc-summarized-pane" type="button" role="tab" aria-selected="false" onclick="switchTab('bbc-summarized')">BBC Summarized</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cnn-tab" data-bs-toggle="tab" data-bs-target="#cnn-pane" type="button" role="tab" aria-selected="false" onclick="switchTab('cnn')">CNN AI Analyzed</button>
            </li>
        </ul>

        <!-- BBC Category Filters -->
        <div id="bbc-category-nav" class="mb-3 d-flex gap-2 flex-wrap justify-content-center">
            <button class="btn btn-sm btn-outline-warning active" onclick="switchCategory('world', this)">World</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('sport', this)">Sport</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('business', this)">Business</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('innovation', this)">Innovation</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('health', this)">Health</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('culture', this)">Culture</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('arts', this)">Arts</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('travel', this)">Travel</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="switchCategory('earth', this)">Earth</button>
        </div>

        <div class="tab-content" id="myTabContent">
            <!-- BBC NEW PANE -->
            <div class="tab-pane fade show active" id="bbc-new-pane" role="tabpanel">
                <div id="bbc-new-status-bar" class="d-none"></div>
                <div class="row g-4" id="bbc-new-container"></div>
            </div>

            <!-- BBC SUMMARIZED PANE -->
            <div class="tab-pane fade" id="bbc-summarized-pane" role="tabpanel">
                <div id="bbc-summarized-status-bar" class="d-none"></div>
                <div class="row g-4" id="bbc-summarized-container"></div>
            </div>

            <!-- CNN MERGED PANE -->
            <div class="tab-pane fade" id="cnn-pane" role="tabpanel">
                <div id="cnn-status-bar" class="d-none"></div>
                <div class="row g-4" id="cnn-container"></div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-warning" id="modal-title">Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-4 border-end border-secondary pe-lg-4">
                            <div class="d-flex align-items-center mb-4 justify-content-between bg-dark p-3 rounded border border-secondary">
                                <div id="urgency-badge" class="impact-badge bg-secondary text-white">PENDING</div>
                                <div class="text-center">
                                    <div class="small text-muted mb-1 text-uppercase" style="font-size: 0.7rem;">Impact Score</div>
                                    <div id="impact-score" class="score-box">-</div>
                                </div>
                            </div>
                            <h6 class="section-title">AI Executive Summary</h6>
                            <p id="ai-summary" class="small text-secondary">Loading...</p>
                            <h6 class="section-title">Economic Impact</h6>
                            <p id="ai-econ" class="small text-secondary">Loading...</p>
                            <h6 class="section-title">Global Impact</h6>
                            <p id="ai-world" class="small text-secondary">Loading...</p>
                        </div>
                        <div class="col-lg-8 ps-lg-4">
                            <h6 class="section-title mt-0">Full Article Content</h6>
                            <div id="article-text" class="article-reader">Loading article content...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between bg-dark border-top border-secondary">
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="toggleRawData()">View Raw JSON</button>
                    <div class="d-flex gap-2">
                         <a href="#" id="original-link" target="_blank" class="btn btn-outline-light btn-sm">Open Original Source</a>
                         <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
                <div id="raw-data-container" class="w-100 p-3 bg-black text-warning font-monospace small d-none" style="max-height: 200px; overflow: auto; border-top: 1px solid #333;"></div>
            </div>
        </div>
    </div>

    <!-- Global Loader -->
    <div class="loader" id="global-loader" style="display: none;">
        <div class="spinner-grow" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3 fw-bold text-white px-3 py-2 rounded bg-dark border border-secondary">Analyzing & Formatting...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTab = 'bbc-new';
        let currentCategory = 'world';

        let bbcPendingCount = 0;

        function normalizeUrl(url) {
            if (!url) return '';
            return url.replace(/^https?:\/\//, '').replace(/\/$/, '').toLowerCase();
        }
        
        function switchCategory(cat, btn) {
            currentCategory = cat;
            // Update UI
            document.querySelectorAll('#bbc-category-nav button').forEach(b => {
                b.classList.remove('active', 'btn-outline-warning');
                b.classList.add('btn-outline-secondary');
            });
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('active', 'btn-outline-warning');
            
            // Reload
            loadBBCSeparated(true);
        }

        function getCachedClusters(tab, lang, model) {
            const key = `clusters_${tab}_${lang}_${model}`;
            const item = localStorage.getItem(key);
            if (item) {
                const { clusters, timestamp } = JSON.parse(item);
                if (Date.now() - timestamp < 3600000) return { clusters, timestamp };
            }
            return null;
        }

        function setCachedClusters(tab, lang, model, clusters) {
            const key = `clusters_${tab}_${lang}_${model}`;
            localStorage.setItem(key, JSON.stringify({ clusters, timestamp: Date.now() }));
        }

        // --- UI Updaters ---
        function showStatusBar(tab, message, isProcessing) {
            const bar = document.getElementById(tab + '-status-bar');
            bar.classList.remove('d-none');
            if (message.includes('Error') || message.includes('Failed')) {
                bar.className = 'alert alert-danger border-danger d-flex align-items-center mb-4 text-danger bg-dark';
                bar.innerHTML = `<div class="me-2">‚ö†Ô∏è</div><div><strong>Issue:</strong> ${message}</div>`;
            } else {
                bar.className = 'ai-status-bar';
                bar.innerHTML = isProcessing ? `<div class="pulsating-dot"></div> <span>${message}</span>` : `<span>${message}</span>`;
            }
        }

        function hideStatusBar(tab) { document.getElementById(tab + '-status-bar').classList.add('d-none'); }

        function renderRawItems(container, items, isBBC) {
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5">No news items found. Check RSS sources.</div>';
                return;
            }
            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 fade-in';
                card.style.animationDelay = (index * 50) + 'ms';
                card.dataset.normalizedLink = normalizeUrl(item.link);
                card.innerHTML = `
                    <div class="card news-card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-truncate-2">${item.title}</h5>
                            <h6 class="card-subtitle mb-3">${new Date(item.published).toLocaleString()}</h6>
                            <p class="card-text small text-secondary">${item.summary || 'Fetching summary...'}</p>
                            
                            <div class="ai-placeholder mt-auto">
                                <div class="d-flex align-items-center loading-label">
                                    <div class="spinner-grow spinner-grow-sm text-secondary me-2" role="status"></div>
                                    <span class="text-muted small">Queued for analysis...</span>
                                </div>
                            </div>
                            
                            <button onclick="openAnalysisModal('${item.title.replace(/'/g, "'")}', '${item.link}')" class="btn btn-outline-secondary btn-sm w-100 mt-3">Read Full Article</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateCardsWithClusters(container, clusters, isBBC) {
            if (!clusters || clusters.length === 0) {
                const loaders = container.querySelectorAll('.loading-label');
                loaders.forEach(l => l.innerHTML = '<span class="text-muted">AI Analysis: Not Available</span>');
                return;
            }
            if (!isBBC) {
                container.innerHTML = '';
                clusters.forEach((cluster, index) => renderSingleClusterCard(container, cluster, index));
            } else {
                clusters.forEach((cluster) => {
                    if (cluster.related_links && cluster.related_links.length > 0) {
                        const originalLinkNorm = normalizeUrl(cluster.related_links[0]);
                        const cards = container.children;
                        for (let cardWrapper of cards) {
                            if (cardWrapper.dataset.normalizedLink === originalLinkNorm) {
                                const aiBox = cardWrapper.querySelector('.ai-placeholder');
                                if (aiBox) {
                                    const rating = cluster.impact_rating || 'N/A';
                                    let ratingClass = 'text-secondary';
                                    if (parseInt(rating) >= 8) ratingClass = 'text-danger fw-bold';
                                    else if (parseInt(rating) >= 5) ratingClass = 'text-warning fw-bold';
                                    const uniqueId = 'details-inline-' + Math.random().toString(36).substr(2, 9);
                                    aiBox.className = 'mt-3 pt-3 border-top border-secondary';
                                    aiBox.style.background = 'transparent';
                                    aiBox.style.border = 'none';
                                    aiBox.innerHTML = `
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="text-warning small text-uppercase mb-0 fw-bold">AI Insight</h6>
                                            <span class="badge bg-dark border border-secondary text-light">Impact: <span class="${ratingClass}">${rating}/10</span></span>
                                        </div>
                                        <p class="text-light small mb-2">${cluster.summary}</p>
                                        
                                        <button class="btn btn-sm btn-link text-muted p-0 text-decoration-none" style="font-size: 0.8rem" type="button" data-bs-toggle="collapse" data-bs-target="#${uniqueId}">
                                            Show Details ‚ñº
                                        </button>
                                        <div class="collapse mt-2" id="${uniqueId}">
                                            <div class="card card-body bg-dark border border-secondary p-2">
                                                <p class="mb-1 small"><strong class="text-info">Econ:</strong> ${cluster.economic_impact}</p>
                                                <p class="mb-1 small"><strong class="text-info">Global:</strong> ${cluster.global_impact}</p>
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        }
                    }
                });
                container.querySelectorAll('.loading-label').forEach(l => l.innerHTML = '<span class="text-muted">No specific analysis found.</span>');
            }
        }

        function renderSingleClusterCard(container, cluster, index) {
            const card = document.createElement('div');
            card.className = 'col-md-12 fade-in';
            const uniqueId = 'details-' + index + '-' + Math.random().toString(36).substr(2, 9);
            const rating = cluster.impact_rating || 'N/A';
            let ratingClass = 'text-secondary';
            if (parseInt(rating) >= 8) ratingClass = 'text-danger fw-bold';
            else if (parseInt(rating) >= 5) ratingClass = 'text-warning fw-bold';

            card.innerHTML = `
                <div class="card news-card mb-4 border-start border-4 border-start-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h3 class="card-title text-warning mb-0">${cluster.topic}</h3>
                            <div class="text-end">
                                <span class="badge bg-dark border border-secondary p-2 d-block mb-1 fs-6">Impact: <span class="${ratingClass}">${rating}/10</span></span>
                                <span class="text-muted small">AI: ${cluster.modelUsed || 'Unknown'}</span>
                            </div>
                        </div>
                        
                        <div class="row g-4">
                            <div class="col-md-8">
                                <h6 class="text-secondary text-uppercase small fw-bold">Executive Summary</h6>
                                <p class="card-text fs-5 text-light">${cluster.summary}</p>
                            </div>
                            <div class="col-md-4 border-start border-secondary ps-4">
                                <h6 class="text-secondary text-uppercase small fw-bold">Economic Impact</h6>
                                <p class="text-info small">${cluster.economic_impact}</p>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-top border-secondary">
                            <button class="btn btn-outline-warning btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#${uniqueId}">‚ñº View Deep Dive & Predictions</button>
                            <div class="collapse mt-3" id="${uniqueId}">
                                <div class="card card-body bg-dark border-secondary">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <h6 class="text-secondary text-uppercase small fw-bold">Global Impact</h6>
                                            <p class="text-light small">${cluster.global_impact || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-secondary text-uppercase small fw-bold">What's Next?</h6>
                                            <p class="text-light small fst-italic">"${cluster.what_next || 'N/A'}"</p>
                                        </div>
                                    </div>
                                    <hr class="border-secondary my-3">
                                    <h6 class="text-secondary text-uppercase small fw-bold">Sources</h6>
                                    <div class="link-list small">${(cluster.related_links||[]).map(l=>`<a href="${l}" target="_blank">üîó ${l}</a>`).join('')}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        // --- Data Loading ---
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 15000 } = options;
            
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            const response = await fetch(resource, {
                ...options,
                signal: controller.signal  
            });
            clearTimeout(id);
            return response;
        }

        async function loadFeed(tabName, rawEndpoint, aiEndpoint, forceRefresh = false) {
            const container = document.getElementById(tabName + '-container');
            const lang = document.getElementById('lang-select').value;
            const model = document.getElementById('model-select').value;
            showStatusBar(tabName, 'Fetching latest headlines...', true);
            try {
                const rawResponse = await fetchWithTimeout(rawEndpoint);
                const rawItems = await rawResponse.json();
                const isBBC = tabName === 'bbc';
                renderRawItems(container, rawItems, isBBC);

                // For BBC tab, use per-article analysis with caching
                if (isBBC) {
                    await loadBBCArticlesWithCache(container, rawItems, lang, model, forceRefresh);
                    return;
                }

                // For CNN tab, use the existing cluster-based approach with cache
                if (!forceRefresh) {
                    const cached = getCachedClusters(tabName, lang, model);
                    if (cached) {
                        // Check if we should warn about BBC priority
                        if (!isBBC && bbcPendingCount > 0) {
                            showStatusBar(tabName, `<strong>Notice:</strong> ${bbcPendingCount} BBC articles are currently being analyzed. CNN analysis is paused until BBC is complete.`, false);
                        } else {
                            showStatusBar(tabName, `Using cached analysis (${new Date(cached.timestamp).toLocaleTimeString()})`, false);
                        }
                        updateCardsWithClusters(container, cached.clusters, isBBC);
                        return;
                    }
                }
                
                // Try to get AI analysis (cached or fresh)
                showStatusBar(tabName, `Fetching AI analysis...`, true);
                
                // Warn about BBC priority if getting fresh data
                if (!isBBC && bbcPendingCount > 0) {
                    showStatusBar(tabName, `<strong>Waiting:</strong> Prioritizing ${bbcPendingCount} pending BBC articles. CNN analysis will resume automatically when finished.`, true);
                    // We still try to fetch in case there is cached data on server
                }
                
                const aiResponse = await fetchWithTimeout(`${aiEndpoint}?lang=${lang}&model=${model}`);
                if (aiResponse.ok) {
                    const clusters = await aiResponse.json();
                    // Cache the clusters if they are valid
                    if (clusters.length > 0 && !clusters[0].topic.includes('Error')) {
                        setCachedClusters(tabName, lang, model, clusters);
                    }
                    updateCardsWithClusters(container, clusters, isBBC);
                    if (clusters.length > 0) {
                        if (clusters[0].topic.includes('Error')) {
                            showStatusBar(tabName, clusters[0].topic + ': ' + clusters[0].summary, false);
                        } else {
                            showStatusBar(tabName, `Analysis Complete. (${clusters.length} topics found)`, false);
                        }
                    } else {
                        showStatusBar(tabName, 'Analysis returned no results.', false);
                        updateCardsWithClusters(container, [], isBBC);
                    }
                } else {
                    // AI analysis fetch failed
                    const errorText = await aiResponse.text();
                    console.error('AI analysis fetch failed:', errorText);
                    const loaders = container.querySelectorAll('.loading-label');
                    loaders.forEach(l => l.innerHTML = `<span class="text-danger">AI Analysis: Failed to load (${aiResponse.status})</span>`);
                    showStatusBar(tabName, 'Analysis failed: ' + errorText, false);
                }
            } catch (error) {
                console.error(error);
                let msg = error.name === 'AbortError' ? 'Request timed out' : error.message;
                showStatusBar(tabName, 'Error: ' + msg, false);
                const loaders = container.querySelectorAll('.loading-label');
                loaders.forEach(l => l.innerHTML = `<span class="text-danger">AI Analysis: ${msg}</span>`);
            }
        }

        async function loadBBCArticlesSeparated(forceRefresh = false) {
            const lang = document.getElementById('lang-select').value;
            const model = document.getElementById('model-select').value;
            const newContainer = document.getElementById('bbc-new-container');
            const summarizedContainer = document.getElementById('bbc-summarized-container');
            
            showStatusBar('bbc-new', `Fetching BBC (${currentCategory}) headlines...`, true);
            showStatusBar('bbc-summarized', 'Loading cached summaries...', true);
            
            try {
                // 1. Fetch Server-Side Summarized/Analyzed News (Background Processed)
                // Note: The summarized list in DB currently mixes ALL categories. 
                // We might want to filter this in the future, but for now it shows all analyzed items.
                const summarizedResponse = await fetchWithTimeout(`/api/news/bbc/merged?lang=${lang}&model=${model}`);
                let summarizedClusters = [];
                if (summarizedResponse.ok) {
                    summarizedClusters = await summarizedResponse.json();
                }

                // 2. Fetch Raw News for specific category
                const rawResponse = await fetchWithTimeout(`/api/news?category=${currentCategory}`);
                const rawItems = await rawResponse.json();
                
                newContainer.innerHTML = '';
                summarizedContainer.innerHTML = '';
                
                const itemMap = new Map();
                if (rawItems) rawItems.forEach(i => itemMap.set(normalizeUrl(i.link), i));
                
                // Render Summarized
                if (summarizedClusters && summarizedClusters.length > 0) {
                     summarizedClusters.sort((a, b) => {
                         const itemA = a.related_links?.[0] ? itemMap.get(normalizeUrl(a.related_links[0])) : null;
                         const itemB = b.related_links?.[0] ? itemMap.get(normalizeUrl(b.related_links[0])) : null;
                         return (itemB ? new Date(itemB.published) : 0) - (itemA ? new Date(itemA.published) : 0);
                     });

                     summarizedClusters.forEach(cluster => {
                         if (cluster.topic && cluster.topic.includes('Error')) return;
                         let originalItem = cluster.related_links?.[0] ? itemMap.get(normalizeUrl(cluster.related_links[0])) : null;
                         const item = originalItem || {
                             title: cluster.topic,
                             link: cluster.related_links?.[0] || '#',
                             published: new Date(),
                             summary: cluster.summary
                         };
                         summarizedContainer.appendChild(createArticleCard(item, cluster, true));
                     });
                     showStatusBar('bbc-summarized', `${summarizedClusters.length} analyzed articles.`, false);
                } else {
                     summarizedContainer.innerHTML = '<div class="col-12 text-center text-muted py-5">No summaries yet.</div>';
                     showStatusBar('bbc-summarized', 'Empty.', false);
                }

                // Render New
                const summarizedLinks = new Set();
                if (summarizedClusters) {
                    summarizedClusters.forEach(c => c.related_links?.forEach(l => summarizedLinks.add(normalizeUrl(l))));
                }
                
                const newItems = (rawItems || []).filter(item => !summarizedLinks.has(normalizeUrl(item.link)));
                newItems.sort((a, b) => new Date(b.published) - new Date(a.published));

                if (newItems.length > 0) {
                     newItems.forEach(item => {
                         const card = createArticleCard(item, null, false);
                         newContainer.appendChild(card);
                     });
                     bbcPendingCount = newItems.length;
                     showStatusBar('bbc-new', `${newItems.length} new articles available in ${currentCategory}.`, false);
                } else {
                     newContainer.innerHTML = '<div class="col-12 text-center text-muted py-5">All caught up!</div>';
                     bbcPendingCount = 0;
                     showStatusBar('bbc-new', 'No new articles.', false);
                }
                
            } catch (error) {
                console.error(error);
                showStatusBar('bbc-new', 'Network Error', false);
            }
        }
        
        function createArticleCard(item, analysis, isAnalyzed) {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 fade-in';
            card.dataset.normalizedLink = normalizeUrl(item.link);
            
            const imageUrl = isAnalyzed ? (analysis.imageUrl || item.imageUrl) : item.imageUrl;
            const imgHtml = imageUrl ? `<img src="${imageUrl}" class="card-img-top" alt="news image" onerror="this.style.display='none'">` : '';

            if (isAnalyzed && analysis) {
                const rating = analysis.impact_rating || 'N/A';
                let ratingClass = 'text-secondary';
                if (parseInt(rating) >= 8) ratingClass = 'text-danger fw-bold';
                else if (parseInt(rating) >= 5) ratingClass = 'text-warning fw-bold';
                const uniqueId = 'details-card-' + Math.random().toString(36).substr(2, 9);
                
                card.innerHTML = `
                    <div class="card news-card h-100">
                        ${imgHtml}
                        <div class="card-body">
                            <h5 class="card-title text-truncate-2">${item.title}</h5>
                            <h6 class="card-subtitle mb-2">${new Date(item.published).toLocaleString()}</h6>
                            
                            <div class="mt-3 pt-3 border-top border-secondary">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-warning small text-uppercase mb-0 fw-bold">AI Insight</h6>
                                    <span class="badge bg-dark border border-secondary text-light">Impact: <span class="${ratingClass}">${rating}/10</span></span>
                                </div>
                                <p class="text-light small mb-3">${analysis.summary}</p>
                                
                                <button class="btn btn-sm btn-outline-warning w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#${uniqueId}">Impact Details ‚ñº</button>
                                <div class="collapse" id="${uniqueId}">
                                    <div class="card card-body bg-dark border border-secondary p-2 mb-2 rounded">
                                        <p class="mb-1 small"><strong class="text-info">Econ:</strong> ${analysis.economic_impact}</p>
                                        <p class="mb-0 small"><strong class="text-info">Global:</strong> ${analysis.global_impact}</p>
                                    </div>
                                </div>
                                
                                <button onclick="openAnalysisModal('${item.title.replace(/'/g, "'")}', '${item.link}')" class="btn btn-secondary btn-sm w-100">Read Full Article</button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="card news-card h-100">
                        ${imgHtml}
                        <div class="card-body">
                            <h5 class="card-title text-truncate-2">${item.title}</h5>
                            <h6 class="card-subtitle mb-2">${new Date(item.published).toLocaleString()}</h6>
                            <p class="card-text small text-secondary">${item.summary || 'Fetching...'}</p>
                            <div class="ai-placeholder mt-auto text-center py-2">
                                <div class="spinner-grow spinner-grow-sm text-secondary me-2" role="status"></div>
                                <span class="text-muted small">Queued for analysis...</span>
                            </div>
                            <button onclick="openAnalysisModal('${item.title.replace(/'/g, "'")}', '${item.link}')" class="btn btn-outline-secondary btn-sm w-100 mt-3">Read Full Article</button>
                        </div>
                    </div>
                `;
            }
            return card;
        }

        let pollInterval;
        function startAutoPoll() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => {
                if (currentTab.includes('bbc')) loadBBCSeparated(false); 
            }, 8000);
        }

                                    function loadBBCSeparated(forceRefresh = false) {
                                        // This function will be implemented below
                                        loadBBCArticlesSeparated(forceRefresh);
                                    }
                                    function loadCNNMerged(forceRefresh = false) { loadFeed('cnn', '/api/news/cnn', '/api/news/merged', forceRefresh); }
                                    function switchTab(tab) { 
                                        currentTab = tab; 
                                        const catNav = document.getElementById('bbc-category-nav');
                                        if (tab === 'bbc-new' || tab === 'bbc-summarized') {
                                            catNav.classList.remove('d-none');
                                            catNav.classList.add('d-flex');
                                            loadBBCSeparated(); 
                                        }
                                        if (tab === 'cnn') {
                                            catNav.classList.add('d-none');
                                            catNav.classList.remove('d-flex');
                                            loadCNNMerged(); 
                                        }
                                    }
                                    function refreshCurrentTab() { 
                                        if (currentTab === 'bbc-new' || currentTab === 'bbc-summarized') loadBBCSeparated(true); 
                                        else if (currentTab === 'cnn') loadCNNMerged(true); 
                                    }

        function toggleRawData() { document.getElementById('raw-data-container').classList.toggle('d-none'); }
        
        async function openAnalysisModal(title, url) {
            const loader = document.getElementById('global-loader');
            const modalElement = new bootstrap.Modal(document.getElementById('analysisModal'));
            const rawContainer = document.getElementById('raw-data-container');
            
            rawContainer.innerHTML = 'Loading raw data...';
            rawContainer.classList.add('d-none');
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('article-text').innerText = "Fetching content..."; 
            document.getElementById('ai-summary').innerText = "Analyzing..."; 
            document.getElementById('ai-econ').innerText = "..."; 
            document.getElementById('ai-world').innerText = "..."; 
            document.getElementById('impact-score').innerText = "-"; 
            
            const urgencyEl = document.getElementById('urgency-badge');
            urgencyEl.className = "impact-badge bg-secondary"; 
            urgencyEl.innerText = "PENDING"; 
            document.getElementById('original-link').href = url;
            
            loader.style.display = 'flex'; // Flex for centering
            try {
                const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: url }) });
                const rawText = await response.text();
                
                let data;
                try {
                    data = JSON.parse(rawText);
                    rawContainer.innerText = JSON.stringify(data, null, 2);
                } catch (e) {
                    rawContainer.innerText = "Non-JSON Response:\n" + rawText;
                }

                if (response.ok) {
                    const ai = data.analysis;
                    document.getElementById('ai-summary').innerText = ai.summary || "No summary."; 
                    document.getElementById('ai-econ').innerText = ai.economic_impact || "N/A"; 
                    document.getElementById('ai-world').innerText = ai.global_impact || "N/A"; 
                    document.getElementById('impact-score').innerText = ai.impact_rating || "?"; 
                    document.getElementById('article-text').innerText = data.full_text || "No text.";      
                    
                    const urgency = (ai.urgency || "Unknown").toUpperCase();    
                    urgencyEl.innerText = urgency; 
                    urgencyEl.className = "impact-badge";
                    if (urgency.includes('HIGH') || urgency.includes('CRITICAL')) urgencyEl.classList.add('bg-danger', 'text-white');  
                    else if (urgency.includes('MEDIUM')) urgencyEl.classList.add('bg-warning', 'text-dark');  
                    else urgencyEl.classList.add('bg-success', 'text-white'); 
                } else {
                    document.getElementById('article-text').innerText = `Error: ${data.error || 'Unknown error'}`;
                }
                modalElement.show();
            } catch(e) { 
                document.getElementById('article-text').innerText = "Connection Failed: " + e.message;     
                modalElement.show(); 
            } finally { 
                loader.style.display = 'none'; 
            }
        }                            
        
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const models = response.ok ? await response.json() : [];
                
                if (!models.find(m => m.name === 'gemini-2.5-flash-lite')) {
                    models.unshift({ name: 'gemini-2.5-flash-lite', displayName: 'Gemini Flash Lite', version: '2.5' });
                }

                const select = document.getElementById('model-select');      
                select.innerHTML = '';
                models.sort((a, b) => a.name.includes('flash') ? -1 : 1);
                
                    models.forEach(model => {
                        const opt = document.createElement('option'); opt.value = model.name; opt.text = model.displayName + " (" + model.version + ")";
                        if (model.name === 'deepseek-chat') opt.selected = true; 
                        select.add(opt);
                    });
                initTooltips();
            } catch (e) { console.error("Model load error:", e); }
        }

        function initTooltips() {
            [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(t => new bootstrap.Tooltip(t));
        }

        async function runImport() {
            const textarea = document.getElementById('import-urls');
            const statusDiv = document.getElementById('import-status');
            const urls = textarea.value.split('\n').map(u => u.trim()).filter(u => u.startsWith('http'));
            
            if (urls.length === 0) {
                statusDiv.innerHTML = '<span class="text-danger">No valid URLs found.</span>';
                return;
            }

            statusDiv.innerHTML = '<span class="text-warning">Processing ' + urls.length + ' articles...</span>';
            const btn = document.querySelector('#importModal .btn-primary');
            btn.disabled = true;

            try {
                const response = await fetch('/api/news/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ urls: urls }) });
                const msg = await response.text();
                statusDiv.innerHTML = `<span class="${response.ok ? 'text-success' : 'text-danger'}">${msg}</span>`;
                if (response.ok) {
                    setTimeout(() => {
                        textarea.value = '';
                        btn.disabled = false;
                        bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();      
                        refreshCurrentTab();
                    }, 2000);
                } else btn.disabled = false;
            } catch (e) {
                statusDiv.innerHTML = '<span class="text-danger">Error: ' + e.message + '</span>';       
                btn.disabled = false;
            }
        }

        let refreshCountdown = 0;
        let refreshTimer = null;
        
        function updateRefreshButton() {
            const button = document.getElementById('refresh-button');
            if (refreshCountdown > 0) {
                button.textContent = `Wait (${refreshCountdown}s)`;
                button.disabled = true;
                button.classList.add('btn-secondary');
                button.classList.remove('btn-outline-light');
            } else {
                button.textContent = 'Refresh';
                button.disabled = false;
                button.classList.remove('btn-secondary');
                button.classList.add('btn-outline-light');
            }
        }
        
        document.getElementById('refresh-button').addEventListener('click', () => {
             if (refreshCountdown > 0) return;
             refreshCountdown = 30;
             updateRefreshButton();
             refreshTimer = setInterval(() => {
                 refreshCountdown--;
                 updateRefreshButton();
                 if (refreshCountdown <= 0) {
                     clearInterval(refreshTimer);
                     refreshTimer = null;
                 }
             }, 1000);
             refreshCurrentTab();
        });
        
        window.onload = function() { 
            loadModels(); 
            loadBBCSeparated(); 
            startAutoPoll(); 
        };    
    </script>
    <footer class="text-center py-4 text-secondary small border-top border-dark mt-auto">
        NewsHub v1.8 | Redesigned Theme | Auto-Fallback Active
    </footer>
</body>
</html>