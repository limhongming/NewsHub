<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #111; color: #ddd; font-family: monospace; }
        .card { background-color: #222; border: 1px solid #444; }
        .form-control { background-color: #000; border: 1px solid #555; color: #0f0; }
        .form-control:focus { background-color: #000; color: #0f0; border-color: #0f0; box-shadow: 0 0 5px #0f0; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; background: #555; margin-right: 5px; }
        .status-dot.success { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .status-dot.error { background: #f00; box-shadow: 0 0 10px #f00; }
        .status-dot.loading { background: #ff0; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0"><span class="text-primary">Gemini</span> API Diagnostic Tool</h3>
            <a href="/" class="btn btn-outline-secondary btn-sm">Back to NewsHub</a>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card p-3 mb-3">
                    <label class="form-label text-muted">Target Model</label>
                    <input type="text" id="model" class="form-control mb-3" value="gemini-2.5-flash-lite">
                    
                    <label class="form-label text-muted">Test Prompt</label>
                    <textarea id="prompt" class="form-control mb-3" rows="3">Explain in 1 sentence why the sky is blue.</textarea>
                    
                    <button onclick="runTest()" class="btn btn-primary w-100" id="testBtn">ðŸš€ Send Request</button>
                </div>
                
                <div class="alert alert-dark border-secondary">
                    <small class="text-muted d-block mb-2">Common Models:</small>
                    <button class="badge bg-secondary border-0 mb-1" onclick="setModel('gemini-2.5-flash-lite')">gemini-2.5-flash-lite</button>
                    <button class="badge bg-secondary border-0 mb-1" onclick="setModel('gemini-1.5-flash')">gemini-1.5-flash</button>
                    <button class="badge bg-secondary border-0 mb-1" onclick="setModel('gemini-1.5-pro')">gemini-1.5-pro</button>
                    <button class="badge bg-secondary border-0 mb-1" onclick="setModel('gemini-pro')">gemini-pro</button>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center">
                        <span>API Response Log</span>
                        <div id="statusIndicator"><span class="status-dot"></span>Idle</div>
                    </div>
                    <div class="card-body p-0">
                        <div id="output" class="p-3 text-success" style="min-height: 300px;">Waiting for test...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function setModel(m) { document.getElementById('model').value = m; }
        
        async function runTest() {
            const model = document.getElementById('model').value;
            const prompt = document.getElementById('prompt').value;
            const output = document.getElementById('output');
            const dot = document.querySelector('.status-dot');
            const btn = document.getElementById('testBtn');
            const statusText = document.getElementById('statusIndicator');

            // Reset UI
            output.innerHTML = '<span class="text-secondary">Sending request to server...</span>';
            output.classList.remove('text-danger', 'text-success');
            dot.className = 'status-dot loading';
            statusText.innerHTML = '<span class="status-dot loading"></span>Connecting...';
            btn.disabled = true;

            try {
                const start = Date.now();
                const response = await fetch('/api/test/direct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model, prompt: prompt })
                });
                
                const text = await response.text();
                const duration = Date.now() - start;
                
                let jsonResult;
                try {
                    jsonResult = JSON.parse(text);
                } catch(e) {
                    jsonResult = null;
                }

                if (response.ok && jsonResult && jsonResult.status === 'SUCCESS') {
                    dot.className = 'status-dot success';
                    statusText.innerHTML = `<span class="status-dot success"></span>Success (${duration}ms)`;
                    output.className = 'p-3 text-success font-monospace';
                    output.innerHTML = `<strong>Status:</strong> 200 OK<br><strong>Model Used:</strong> ${jsonResult.model_used}<br><br><strong>Response:</strong><br>${jsonResult.extracted_text}`;
                } else {
                    dot.className = 'status-dot error';
                    statusText.innerHTML = `<span class="status-dot error"></span>Failed (${duration}ms)`;
                    output.className = 'p-3 text-danger font-monospace';
                    
                    let errorDisplay = text;
                    if (jsonResult && jsonResult.message) errorDisplay = jsonResult.message;
                    
                    output.innerHTML = `<strong>Error:</strong><br>${errorDisplay}`;
                }
            } catch (e) {
                dot.className = 'status-dot error';
                statusText.innerHTML = '<span class="status-dot error"></span>Network Error';
                output.className = 'p-3 text-danger';
                output.innerText = "Frontend Fetch Error: " + e.message;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
